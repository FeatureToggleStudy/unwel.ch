language: node_js

node_js:
  - "10"

services:
  - docker

branches:
  only:
    - master

cache:
  yarn: true
  directories:
    - node_modules

env:
  API_HOST: "https://api.unwel.ch"

before_install:
  - "curl -o- -L https://yarnpkg.com/install.sh | bash"
  - export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"

install:
  - cd backend
  - yarn
  - cd ..
  - cd frontend
  - yarn
  - cd ..

script:
  - cd frontend
  - yarn build
  - cd ..
  - cd backend
  - yarn test
  - yarn build
  - cd ..

before_deploy:
  - docker login -u="$DOCKERHUB_USERNAME" -p="$DOCKERHUB_PASSWORD"
  - docker build -t frontend ./frontend
  - docker build -t backend ./backend
  - docker tag frontend unwelch/frontend
  - docker tag backend unwelch/backend

deploy:
  provider: script
  script:
    - docker push unwelch/frontend
    - docker push unwelch/backend
  on:
    branch: master
